/**
 * Moments é¡µé¢æ ¸å¿ƒç±»ï¼ˆä½¿ç”¨ ES2022 ç§æœ‰é™æ€å­—æ®µï¼‰
 * è´Ÿè´£æ•°æ®åŠ è½½ã€åˆå¹¶ã€æŒä¹…åŒ–ã€æ¸²æŸ“ä»¥åŠäº‹ä»¶ç®¡ç†ã€‚
 */
class MomentsPage {
    /* ---------- ç§æœ‰é™æ€å­—æ®µ ---------- */
    static #data = [];                     // å®Œæ•´æ•°æ®é›†åˆ
    static #isRendering = false;          // é˜²æ­¢å¹¶å‘æ¸²æŸ“
    static #renderQueue = [];             // å¾…æ¸²æŸ“ä»»åŠ¡é˜Ÿåˆ—
    static #virtualScroll = null;         // è™šæ‹Ÿæ»šåŠ¨å®ä¾‹ï¼ˆåæ–‡å®ç°ï¼‰
    static #PAGE_SIZE = 30;               // æ¯æ¬¡æ¸²æŸ“çš„æ¡ç›®æ•°ï¼ˆè™šæ‹Ÿæ»šåŠ¨ï¼‰

    /* ---------- å…¬å…±å…¥å£ ---------- */
    static async init() {
        try {
            await this.#loadData();               // è¯»å–æœ¬åœ°ã€Firebaseã€é»˜è®¤æ•°æ®å¹¶åˆå¹¶
            this.#bindEvents();                   // ç»‘å®š UI äº¤äº’
            await this.render();                  // é¦–æ¬¡æ¸²æŸ“
            // ç›‘å¬è¯­è¨€å˜åŒ–ï¼Œè‡ªåŠ¨é‡æ–°æ¸²æŸ“
            appState.on('languageChanged', () => this.render());
            // æ³¨å†Œå†…å­˜æ¸…ç†å›è°ƒ
            MemoryManager.registerCleanup(() => this.cleanup());
        } catch (e) {
            console.error('MomentsPage åˆå§‹åŒ–å¤±è´¥:', e);
        }
    }

    /* ---------- æ•°æ®åŠ è½½ä¸åˆå¹¶ ---------- */
    static async #loadData() {
        try {
            const savedData = this.#loadFromStorage();
            const defaultData = window.momentsData || [];
            const fbSyncedData = await this.#syncFirebaseData();

            this.#data = this.#mergeData(savedData, fbSyncedData, defaultData);
            this.#ensureDataIds();
            this.#saveData();   // å°†åˆå¹¶åçš„ç»“æœå†™å›æœ¬åœ°ï¼ˆå¹¶å¼‚æ­¥åŒæ­¥åˆ° Firebaseï¼‰
        } catch (error) {
            console.error('åŠ è½½æœ‹å‹åœˆæ•°æ®å¤±è´¥:', error);
            // è¯»å–ä¸åˆ°ä»»ä½•æ•°æ®æ—¶ä»ä¿æŒé»˜è®¤æ•°æ®ï¼Œä»¥å…é¡µé¢ç©ºç™½
            this.#data = window.momentsData || [];
        }
    }

    static #loadFromStorage() {
        try {
            const raw = appState.loadFromStorage(CONFIG.STORAGE_KEYS.moments);
            return raw ? JSON.parse(raw) : null;
        } catch (e) {
            console.warn('æœ¬åœ°å­˜å‚¨è¯»å–å¼‚å¸¸ï¼Œå·²å›é€€åˆ°é»˜è®¤æ•°æ®', e);
            return null;
        }
    }

    static async #syncFirebaseData() {
        // æœ¬åœ°è°ƒè¯•æˆ–ç¦»çº¿æ¨¡å¼ä¸‹ç›´æ¥è¿”å›ç©ºæ•°ç»„
        if (window.firebaseHandler.useLocalStorage) return [];

        try {
            return await window.firebaseHandler.syncMomentsData();
        } catch (error) {
            console.error('Firebase æ•°æ®åŒæ­¥å¤±è´¥:', error);
            return [];
        }
    }

    static #mergeData(saved, firebase, defaults) {
        const allIds = new Set();
        const merged = [];

        // åˆå¹¶é¡ºåºï¼šFirebase > æœ¬åœ°ä¿å­˜ > é»˜è®¤æ•°æ®ï¼ˆä¼˜å…ˆçº§é«˜çš„åœ¨å‰ï¼‰
        [firebase, saved, defaults].forEach(source => {
            if (!source) return;
            source.forEach(item => {
                if (item.id && !allIds.has(item.id)) {
                    allIds.add(item.id);
                    merged.push(item);
                }
            });
        });
        return merged;
    }

    static #ensureDataIds() {
        this.#data = this.#data.map(m => ({
            ...m,
            id: m.id || Utils.generateId('moment_')
        }));
    }

    static #saveData() {
        try {
            const payload = JSON.stringify(this.#data);
            appState.saveToStorage(CONFIG.STORAGE_KEYS.moments, payload);

            // å¼‚æ­¥åŒæ­¥åˆ° Firebaseï¼ˆä¸é˜»å¡ UIï¼‰
            if (!window.firebaseHandler.useLocalStorage) {
                window.firebaseHandler.saveMomentsToFirebase(this.#data).catch(console.error);
            }
        } catch (e) {
            console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
        }
    }

    /* ---------- äº‹ä»¶ç»‘å®š ---------- */
    static #bindEvents() {
        this.#clearEventListeners();
        this.#bindSearch();
        this.#bindCategories();
        this.#initCommentModal();
        LanguageManager.updatePageTexts(); // é¦–æ¬¡æ¸²æŸ“å‰ç¡®ä¿è¯­è¨€æ–‡æœ¬å·²æ›´æ–°
    }

    static #clearEventListeners() {
        EventManager.clearAll();
    }

    static #bindSearch() {
        const searchInput = document.getElementById('momentsSearch');
        if (!searchInput) return;

        // ä½¿ç”¨ debounce é˜²æ­¢è¾“å…¥é¢‘ç¹è§¦å‘æ¸²æŸ“
        const handler = Utils.debounce(e => {
            this.handleSearch(e.target.value);
        }, CONFIG.PERFORMANCE.DEBOUNCE_DELAY);

        searchInput.addEventListener('input', handler);
    }

    static #bindCategories() {
        const container = document.querySelector('.category-filters');
        if (!container) return;

        // é‡‡ç”¨äº‹ä»¶å§”æ‰˜ï¼Œé¿å…ä¸ºæ¯ä¸ªæŒ‰é’®å•ç‹¬ç»‘å®š
        EventManager.delegate(container, 'click', '.category-filter', (e, target) => {
            e.preventDefault();
            const category = target.dataset.category;
            appState.currentCategory = category;
            this.render(); // åˆ‡æ¢åˆ†ç±»åç«‹å³æ¸²æŸ“
        });
    }

    static #initCommentModal() {
        // è¿™é‡Œå¯ä»¥æ”¾ç½®è¯„è®ºå¼¹çª—çš„åˆå§‹åŒ–é€»è¾‘ï¼ˆå¦‚å®ä¾‹åŒ– Modalã€ç»‘å®šå…³é—­äº‹ä»¶ç­‰ï¼‰
        // ç¤ºä¾‹ï¼š
        // this.#commentModal = new CommentModal('#commentModal');
    }

    /* ---------- æ¸²æŸ“å…¥å£ ---------- */
    static async render(filteredData = null) {
        // é˜²æ­¢å¹¶å‘æ¸²æŸ“ï¼šè‹¥å·²æœ‰æ¸²æŸ“ä»»åŠ¡åœ¨æ‰§è¡Œï¼Œåˆ™æŠŠæœ¬æ¬¡è¯·æ±‚å‹å…¥é˜Ÿåˆ—
        if (this.#isRendering) {
            this.#renderQueue.push(filteredData);
            return;
        }

        this.#isRendering = true;
        try {
            const container = document.getElementById('momentsContainer');
            if (!container) {
                console.warn('æ¸²æŸ“å®¹å™¨ #momentsContainer æœªæ‰¾åˆ°');
                return;
            }

            // åœæ­¢ Firebase å®æ—¶ç›‘å¬ï¼Œé˜²æ­¢æ¸²æŸ“æœŸé—´æ•°æ®çªå˜
            if (window.firebaseHandler && typeof window.firebaseHandler.stopListening === 'function') {
                window.firebaseHandler.stopListening();
            }

            const dataToRender = filteredData || this.#data;
            const filtered = this.#filterByCategory(dataToRender);
            const sorted = this.#sortByDate(filtered);

            if (sorted.length === 0) {
                container.innerHTML = this.#renderEmptyState();
                return;
            }

            // ---------- è™šæ‹Ÿæ»šåŠ¨æ¸²æŸ“ ----------
            // è‹¥å·²æœ‰è™šæ‹Ÿæ»šåŠ¨å®ä¾‹åˆ™å¤ç”¨ï¼Œå¦åˆ™åˆ›å»ºæ–°å®ä¾‹
            if (!this.#virtualScroll) {
                this.#virtualScroll = new VirtualScroll({
                    container,
                    itemHeight: 120,               // ä¼°ç®—çš„å•æ¡ç›®é«˜åº¦ï¼ˆå¯æ ¹æ®å®é™… UI è°ƒæ•´ï¼‰
                    pageSize: this.#PAGE_SIZE,
                    renderItem: this.#renderMomentItem.bind(this)
                });
            }
            this.#virtualScroll.updateData(sorted);
            this.#virtualScroll.refresh(); // è§¦å‘é¦–æ¬¡æ¸²æŸ“

        } catch (e) {
            console.error('æ¸²æŸ“è¿‡ç¨‹å‡ºé”™:', e);
        } finally {
            this.#isRendering = false;
            // å¤„ç†é˜Ÿåˆ—ä¸­çš„åç»­æ¸²æŸ“è¯·æ±‚
            if (this.#renderQueue.length > 0) {
                const next = this.#renderQueue.shift();
                this.render(next);
            }
        }
    }

    /* ---------- æ•°æ®è¿‡æ»¤ & æ’åº ---------- */
    static #filterByCategory(data) {
        const cur = appState.currentCategory;
        if (!cur || cur === 'all') return data;
        return data.filter(item => item.category === cur);
    }

    static #sortByDate(data) {
        // æŒ‰æ—¶é—´å€’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰ï¼Œè‹¥æ—¶é—´å­—æ®µä¸å­˜åœ¨åˆ™ä¿æŒåŸé¡ºåº
        return data.slice().sort((a, b) => {
            const ta = new Date(a.time).getTime() || 0;
            const tb = new Date(b.time).getTime() || 0;
            return tb - ta;
        });
    }

    /* ---------- å•æ¡ç›®æ¸²æŸ“ ---------- */
    static #renderMomentItem(item) {
        // è¿™é‡Œè¿”å›å®Œæ•´çš„ HTML ç‰‡æ®µï¼Œä¾› VirtualScroll æ’å…¥åˆ°å®¹å™¨ä¸­
        // ä¸ºäº†ä¿æŒä»£ç ç®€æ´ï¼Œä»…ç¤ºä¾‹å…³é”®å­—æ®µï¼Œå®é™…å¯è‡ªè¡Œè¡¥å…¨æ ·å¼ä¸äº¤äº’
        return `
            <div class="moment-item" data-id="${item.id}">
                <div class="moment-header">
                    <img class="avatar" src="${item.avatar || 'default-avatar.png'}" alt="å¤´åƒ">
                    <span class="username">${item.username || 'åŒ¿å'}</span>
                    <span class="time">${new Date(item.time).toLocaleString()}</span>
                </div>
                <div class="moment-content">${item.content || ''}</div>
                ${item.images ? `<div class="moment-images">${item.images.map(src => `<img src="${src}" alt="å›¾ç‰‡">`).join('')}</div>` : ''}
                <div class="moment-actions">
                    <button class="like-btn">ğŸ‘ ${item.likes || 0}</button>
                    <button class="comment-btn">ğŸ’¬ ${item.comments?.length || 0}</button>
                </div>
            </div>
        `;
    }

    /* ---------- ç©ºçŠ¶æ€æ¸²æŸ“ ---------- */
    static #renderEmptyState() {
        return `
            <div class="empty-state">
                <p>æš‚æ— åŠ¨æ€ï¼Œå¿«å»å‘å¸ƒç¬¬ä¸€æ¡å§ï¼</p>
            </div>
        `;
    }

    /* ---------- æ¸…ç†èµ„æº ---------- */
    static cleanup() {
        // è§£é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
        this.#clearEventListeners();

        // é”€æ¯è™šæ‹Ÿæ»šåŠ¨å®ä¾‹ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        if (this.#virtualScroll && typeof this.#virtualScroll.destroy === 'function') {
            this.#virtualScroll.destroy();
            this.#virtualScroll = null;
        }

        // å…³é—­ Firebase å®æ—¶ç›‘å¬
        if (window.firebaseHandler && typeof window.firebaseHandler.stopListening === 'function') {
            window.firebaseHandler.stopListening();
        }
    }

    /* ---------- æœç´¢å¤„ç†ï¼ˆç¤ºä¾‹å®ç°ï¼‰ ---------- */
    static handleSearch(keyword) {
        const trimmed = keyword.trim().toLowerCase();
        if (!trimmed) {
            this.render(); // æ¸…ç©ºæœç´¢æ—¶æ¢å¤å…¨éƒ¨
            return;
        }

        const filtered = this.#data.filter(item => {
            const text = `${item.username || ''} ${item.content || ''}`.toLowerCase();
            return text.includes(trimmed);
        });
        this.render(filtered);
    }
}

/* ---------- è™šæ‹Ÿæ»šåŠ¨å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰ ---------- */
class VirtualScroll {
    /**
     * @param {Object} options
     *   container: æ¸²æŸ“å®¹å™¨ DOM
     *   itemHeight: å•æ¡ç›®é¢„ä¼°é«˜åº¦ï¼ˆåƒç´ ï¼‰
     *   pageSize: æ¯æ¬¡æ¸²æŸ“çš„æ¡ç›®æ•°é‡
     *   renderItem: (item) => HTMLString
     */
    constructor({ container, itemHeight = 120, pageSize = 30, renderItem }) {
        this.container = container;
        this.itemHeight = itemHeight;
        this.pageSize = pageSize;
        this.renderItem = renderItem;

        this.data = [];
        this.totalHeight = 0;
        this.scrollHandler = this.onScroll.bind(this);
        this.container.addEventListener('scroll', this.scrollHandler);
    }

    updateData(data) {
        this.data = data;
        this.totalHeight = data.length * this.itemHeight;
    }

    refresh() {
        // åˆå§‹åŒ–å ä½å®¹å™¨
        this.container.innerHTML = `<div class="vs-spacer" style="height:${this.totalHeight}px;position:relative;"></div>`;
        this.renderVisible(); // é¦–æ¬¡æ¸²æŸ“å¯è§†åŒº
    }

    onScroll() {
        this.renderVisible();
    }

    renderVisible() {
        const scrollTop = this.container.scrollTop;
        const containerHeight = this.container.clientHeight;

        const startIdx = Math.max(0, Math.floor(scrollTop / this.itemHeight) - this.pageSize);
        const endIdx = Math.min(this.data.length, Math.ceil((scrollTop + containerHeight) / this.itemHeight) + this.pageSize);

        const fragment = document.createDocumentFragment();
        for (let i = startIdx; i < endIdx; i++) {
            const itemHtml = this.renderItem(this.data[i]);
            const wrapper = document.createElement('div');
            wrapper.style.position = 'absolute';
            wrapper.style.top = `${i * this.itemHeight}px`;
            wrapper.style.width = '100%';
            wrapper.innerHTML = itemHtml;
            fragment.appendChild(wrapper);
        }

        // æ¸…ç©ºæ—§å†…å®¹åæ’å…¥æ–°å†…å®¹
        const spacer = this.container.querySelector('.vs-spacer');
        spacer.innerHTML = ''; // ç§»é™¤æ—§å­èŠ‚ç‚¹
        spacer.appendChild(fragment);
    }

    destroy() {
        this.container.removeEventListener('scroll', this.scrollHandler);
        this.container.innerHTML = '';
        this.data = [];
    }
}

/* ---------- å¯åŠ¨å…¥å£ ---------- */
document.addEventListener('DOMContentLoaded', () => {
    MomentsPage.init();
});
