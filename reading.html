/**
 * Moments 页面核心类（使用 ES2022 私有静态字段）
 * 负责数据加载、合并、持久化、渲染以及事件管理。
 */
class MomentsPage {
    /* ---------- 私有静态字段 ---------- */
    static #data = [];                     // 完整数据集合
    static #isRendering = false;          // 防止并发渲染
    static #renderQueue = [];             // 待渲染任务队列
    static #virtualScroll = null;         // 虚拟滚动实例（后文实现）
    static #PAGE_SIZE = 30;               // 每次渲染的条目数（虚拟滚动）

    /* ---------- 公共入口 ---------- */
    static async init() {
        try {
            await this.#loadData();               // 读取本地、Firebase、默认数据并合并
            this.#bindEvents();                   // 绑定 UI 交互
            await this.render();                  // 首次渲染
            // 监听语言变化，自动重新渲染
            appState.on('languageChanged', () => this.render());
            // 注册内存清理回调
            MemoryManager.registerCleanup(() => this.cleanup());
        } catch (e) {
            console.error('MomentsPage 初始化失败:', e);
        }
    }

    /* ---------- 数据加载与合并 ---------- */
    static async #loadData() {
        try {
            const savedData = this.#loadFromStorage();
            const defaultData = window.momentsData || [];
            const fbSyncedData = await this.#syncFirebaseData();

            this.#data = this.#mergeData(savedData, fbSyncedData, defaultData);
            this.#ensureDataIds();
            this.#saveData();   // 将合并后的结果写回本地（并异步同步到 Firebase）
        } catch (error) {
            console.error('加载朋友圈数据失败:', error);
            // 读取不到任何数据时仍保持默认数据，以免页面空白
            this.#data = window.momentsData || [];
        }
    }

    static #loadFromStorage() {
        try {
            const raw = appState.loadFromStorage(CONFIG.STORAGE_KEYS.moments);
            return raw ? JSON.parse(raw) : null;
        } catch (e) {
            console.warn('本地存储读取异常，已回退到默认数据', e);
            return null;
        }
    }

    static async #syncFirebaseData() {
        // 本地调试或离线模式下直接返回空数组
        if (window.firebaseHandler.useLocalStorage) return [];

        try {
            return await window.firebaseHandler.syncMomentsData();
        } catch (error) {
            console.error('Firebase 数据同步失败:', error);
            return [];
        }
    }

    static #mergeData(saved, firebase, defaults) {
        const allIds = new Set();
        const merged = [];

        // 合并顺序：Firebase > 本地保存 > 默认数据（优先级高的在前）
        [firebase, saved, defaults].forEach(source => {
            if (!source) return;
            source.forEach(item => {
                if (item.id && !allIds.has(item.id)) {
                    allIds.add(item.id);
                    merged.push(item);
                }
            });
        });
        return merged;
    }

    static #ensureDataIds() {
        this.#data = this.#data.map(m => ({
            ...m,
            id: m.id || Utils.generateId('moment_')
        }));
    }

    static #saveData() {
        try {
            const payload = JSON.stringify(this.#data);
            appState.saveToStorage(CONFIG.STORAGE_KEYS.moments, payload);

            // 异步同步到 Firebase（不阻塞 UI）
            if (!window.firebaseHandler.useLocalStorage) {
                window.firebaseHandler.saveMomentsToFirebase(this.#data).catch(console.error);
            }
        } catch (e) {
            console.error('保存数据失败:', e);
        }
    }

    /* ---------- 事件绑定 ---------- */
    static #bindEvents() {
        this.#clearEventListeners();
        this.#bindSearch();
        this.#bindCategories();
        this.#initCommentModal();
        LanguageManager.updatePageTexts(); // 首次渲染前确保语言文本已更新
    }

    static #clearEventListeners() {
        EventManager.clearAll();
    }

    static #bindSearch() {
        const searchInput = document.getElementById('momentsSearch');
        if (!searchInput) return;

        // 使用 debounce 防止输入频繁触发渲染
        const handler = Utils.debounce(e => {
            this.handleSearch(e.target.value);
        }, CONFIG.PERFORMANCE.DEBOUNCE_DELAY);

        searchInput.addEventListener('input', handler);
    }

    static #bindCategories() {
        const container = document.querySelector('.category-filters');
        if (!container) return;

        // 采用事件委托，避免为每个按钮单独绑定
        EventManager.delegate(container, 'click', '.category-filter', (e, target) => {
            e.preventDefault();
            const category = target.dataset.category;
            appState.currentCategory = category;
            this.render(); // 切换分类后立即渲染
        });
    }

    static #initCommentModal() {
        // 这里可以放置评论弹窗的初始化逻辑（如实例化 Modal、绑定关闭事件等）
        // 示例：
        // this.#commentModal = new CommentModal('#commentModal');
    }

    /* ---------- 渲染入口 ---------- */
    static async render(filteredData = null) {
        // 防止并发渲染：若已有渲染任务在执行，则把本次请求压入队列
        if (this.#isRendering) {
            this.#renderQueue.push(filteredData);
            return;
        }

        this.#isRendering = true;
        try {
            const container = document.getElementById('momentsContainer');
            if (!container) {
                console.warn('渲染容器 #momentsContainer 未找到');
                return;
            }

            // 停止 Firebase 实时监听，防止渲染期间数据突变
            if (window.firebaseHandler && typeof window.firebaseHandler.stopListening === 'function') {
                window.firebaseHandler.stopListening();
            }

            const dataToRender = filteredData || this.#data;
            const filtered = this.#filterByCategory(dataToRender);
            const sorted = this.#sortByDate(filtered);

            if (sorted.length === 0) {
                container.innerHTML = this.#renderEmptyState();
                return;
            }

            // ---------- 虚拟滚动渲染 ----------
            // 若已有虚拟滚动实例则复用，否则创建新实例
            if (!this.#virtualScroll) {
                this.#virtualScroll = new VirtualScroll({
                    container,
                    itemHeight: 120,               // 估算的单条目高度（可根据实际 UI 调整）
                    pageSize: this.#PAGE_SIZE,
                    renderItem: this.#renderMomentItem.bind(this)
                });
            }
            this.#virtualScroll.updateData(sorted);
            this.#virtualScroll.refresh(); // 触发首次渲染

        } catch (e) {
            console.error('渲染过程出错:', e);
        } finally {
            this.#isRendering = false;
            // 处理队列中的后续渲染请求
            if (this.#renderQueue.length > 0) {
                const next = this.#renderQueue.shift();
                this.render(next);
            }
        }
    }

    /* ---------- 数据过滤 & 排序 ---------- */
    static #filterByCategory(data) {
        const cur = appState.currentCategory;
        if (!cur || cur === 'all') return data;
        return data.filter(item => item.category === cur);
    }

    static #sortByDate(data) {
        // 按时间倒序（最新在前），若时间字段不存在则保持原顺序
        return data.slice().sort((a, b) => {
            const ta = new Date(a.time).getTime() || 0;
            const tb = new Date(b.time).getTime() || 0;
            return tb - ta;
        });
    }

    /* ---------- 单条目渲染 ---------- */
    static #renderMomentItem(item) {
        // 这里返回完整的 HTML 片段，供 VirtualScroll 插入到容器中
        // 为了保持代码简洁，仅示例关键字段，实际可自行补全样式与交互
        return `
            <div class="moment-item" data-id="${item.id}">
                <div class="moment-header">
                    <img class="avatar" src="${item.avatar || 'default-avatar.png'}" alt="头像">
                    <span class="username">${item.username || '匿名'}</span>
                    <span class="time">${new Date(item.time).toLocaleString()}</span>
                </div>
                <div class="moment-content">${item.content || ''}</div>
                ${item.images ? `<div class="moment-images">${item.images.map(src => `<img src="${src}" alt="图片">`).join('')}</div>` : ''}
                <div class="moment-actions">
                    <button class="like-btn">👍 ${item.likes || 0}</button>
                    <button class="comment-btn">💬 ${item.comments?.length || 0}</button>
                </div>
            </div>
        `;
    }

    /* ---------- 空状态渲染 ---------- */
    static #renderEmptyState() {
        return `
            <div class="empty-state">
                <p>暂无动态，快去发布第一条吧！</p>
            </div>
        `;
    }

    /* ---------- 清理资源 ---------- */
    static cleanup() {
        // 解除所有事件监听，防止内存泄漏
        this.#clearEventListeners();

        // 销毁虚拟滚动实例（如果有的话）
        if (this.#virtualScroll && typeof this.#virtualScroll.destroy === 'function') {
            this.#virtualScroll.destroy();
            this.#virtualScroll = null;
        }

        // 关闭 Firebase 实时监听
        if (window.firebaseHandler && typeof window.firebaseHandler.stopListening === 'function') {
            window.firebaseHandler.stopListening();
        }
    }

    /* ---------- 搜索处理（示例实现） ---------- */
    static handleSearch(keyword) {
        const trimmed = keyword.trim().toLowerCase();
        if (!trimmed) {
            this.render(); // 清空搜索时恢复全部
            return;
        }

        const filtered = this.#data.filter(item => {
            const text = `${item.username || ''} ${item.content || ''}`.toLowerCase();
            return text.includes(trimmed);
        });
        this.render(filtered);
    }
}

/* ---------- 虚拟滚动实现（简化版） ---------- */
class VirtualScroll {
    /**
     * @param {Object} options
     *   container: 渲染容器 DOM
     *   itemHeight: 单条目预估高度（像素）
     *   pageSize: 每次渲染的条目数量
     *   renderItem: (item) => HTMLString
     */
    constructor({ container, itemHeight = 120, pageSize = 30, renderItem }) {
        this.container = container;
        this.itemHeight = itemHeight;
        this.pageSize = pageSize;
        this.renderItem = renderItem;

        this.data = [];
        this.totalHeight = 0;
        this.scrollHandler = this.onScroll.bind(this);
        this.container.addEventListener('scroll', this.scrollHandler);
    }

    updateData(data) {
        this.data = data;
        this.totalHeight = data.length * this.itemHeight;
    }

    refresh() {
        // 初始化占位容器
        this.container.innerHTML = `<div class="vs-spacer" style="height:${this.totalHeight}px;position:relative;"></div>`;
        this.renderVisible(); // 首次渲染可视区
    }

    onScroll() {
        this.renderVisible();
    }

    renderVisible() {
        const scrollTop = this.container.scrollTop;
        const containerHeight = this.container.clientHeight;

        const startIdx = Math.max(0, Math.floor(scrollTop / this.itemHeight) - this.pageSize);
        const endIdx = Math.min(this.data.length, Math.ceil((scrollTop + containerHeight) / this.itemHeight) + this.pageSize);

        const fragment = document.createDocumentFragment();
        for (let i = startIdx; i < endIdx; i++) {
            const itemHtml = this.renderItem(this.data[i]);
            const wrapper = document.createElement('div');
            wrapper.style.position = 'absolute';
            wrapper.style.top = `${i * this.itemHeight}px`;
            wrapper.style.width = '100%';
            wrapper.innerHTML = itemHtml;
            fragment.appendChild(wrapper);
        }

        // 清空旧内容后插入新内容
        const spacer = this.container.querySelector('.vs-spacer');
        spacer.innerHTML = ''; // 移除旧子节点
        spacer.appendChild(fragment);
    }

    destroy() {
        this.container.removeEventListener('scroll', this.scrollHandler);
        this.container.innerHTML = '';
        this.data = [];
    }
}

/* ---------- 启动入口 ---------- */
document.addEventListener('DOMContentLoaded', () => {
    MomentsPage.init();
});
